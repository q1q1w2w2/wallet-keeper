<!DOCTYPE html>
<html lang='ko' xmlns:th='http://www.thymeleaf.org'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='/css/styles.css'>
    <title>Wallet Keeper</title>
    <style>
        html, body {
            height: 100%; /* 전체 높이 설정 */
            margin: 0; /* 기본 여백 제거 */
            overflow: hidden; /* 스크롤 제거 */
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column; /* 세로 방향으로 배치 */
        }

        .main {
            display: flex;
            flex: 1; /* 남은 공간을 차지 */
            height: calc(100% - 50px); /* 상단바 높이만큼 제외 */
        }

        .content {
            padding: 15px;
            flex: 1; /* 나머지 공간을 차지 */
            background-color: var(--background-color); /* 콘텐츠 배경 색상 */
            overflow-y: auto; /* 세로 스크롤 가능 */
        }

        .date-range {
            margin-bottom: 20px; /* 날짜 선택기와 데이터 영역 사이 여백 */
        }

        .table-container {
            background-color: #ffffff; /* 테이블 배경 색상 */
            border-radius: 8px; /* 모서리 둥글게 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 그림자 효과 */
            overflow: hidden; /* 자식 요소 넘침 방지 */
            max-height: 550px; /* 테이블 최대 높이 설정 */
            overflow-y: auto; /* 세로 스크롤 가능 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #d5d5d5;
            padding: 12px; /* 패딩 증가 */
            cursor: pointer; /* 커서 변경 */
        }

        th {
            background-color: #f1f1f1;
            font-weight: bold; /* 글씨 두껍게 */
            text-align: center; /* 모든 제목 행 가운데 정렬 */
        }

        td {
            text-align: left; /* 기본 왼쪽 정렬 */
        }

        tr:hover {
            background-color: #f9f9f9; /* 마우스 오버 시 배경색 변경 */
        }

        .income {
            color: #1f88ff;
        }

        .expense {
            color: #ff647b;
        }

        .date-column {
            width: 20%;
        }

        .category-column {
            width: 20%;
            text-align: center;
        }

        .detail-column {
            width: 20%;
        }

        .amount-column {
            width: 20%;
            text-align: center;
        }

        .description-column {
            width: 20%;
        }

        .category-data {
            color: #7a7a7a;
        }

        .amount-data {
            text-align: right;
        }
    </style>
</head>
<body>

<div th:replace='~{fragments/fragments :: navbar}'></div>

<div class='main'>
    <div th:replace='~{fragments/fragments :: sidebar}'></div>

    <div class='content'>
        <h2>내역</h2>

        <div class='date-range'>
            <label for='start-date'>시작 날짜:</label>
            <input type='date' id='start-date'>
            <label for='end-date'>종료 날짜:</label>
            <input type='date' id='end-date'>
            <button onclick='filterData()'>조회</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th class="date-column">날짜</th>
                    <th class="detail-column">내용</th>
                    <th class="category-column">카테고리</th>
                    <th class="amount-column">금액</th>
                    <th class="description-column">메모</th>
                </tr>
                </thead>

                <tbody id='data-table'>
                <!-- 거래 내역 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type='module'>
    import {getUserInfo} from '/js/getUserInfo.js';

    const accessToken = localStorage.getItem('accessToken');
    const refreshToken = localStorage.getItem('refreshToken');

    let userId = '';
    let nickname = '';
    let email = '';

    function filterData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        alert(`시작 날짜: ${startDate}, 종료 날짜: ${endDate}`);
    }

    function getTransactionList() {
        fetch('/api/transaction/list', {
            method: 'GET',
            headers: {
                'Content-type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("거래 내역을 불러오는 데 실패했습니다.");
                }
                console.log("거래 내역을 성공적으로 불러왔습니다.");
                return response.json();
            })
            .then(data => {
                const dataTable = document.getElementById('data-table');
                dataTable.innerHTML = '';

                data.data.forEach(transaction => {
                    const row = createTransactionRow(transaction);
                    dataTable.appendChild(row);
                });
            })
            .catch(error => {
                console.error(error);
                alert(error.message);
            })
    }

    function createTransactionRow(transaction) {
        const amountClass = transaction.transactionType === 'INCOME' ? 'income' : 'expense';
        const row = document.createElement('tr');

        row.setAttribute('data-transaction-id', transaction.transactionId);
        row.setAttribute('data-transaction-type', transaction.transactionType);

        row.innerHTML = `
            <td>${formatDate(transaction.transactionAt)}</td>
            <td>${transaction.detail}</td>
            <td class="category-column category-data">${transaction.transactionCategory}</td>
            <td class="${amountClass} amount-column amount-data">${transaction.amount.toLocaleString() + "원"}</td>
            <td>${transaction.description}</td>
        `;

        row.onclick = function() {
            const transactionId = this.getAttribute('data-transaction-id');
            const transactionType = this.getAttribute('data-transaction-type');
            alert(`선택한 거래 ID: ${transactionId}, 거래 유형: ${transactionType}`);
        };

        return row;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);

        const year = String(date.getFullYear()).slice(-2); // 마지막 두 자리
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 월 (0부터 시작하므로 +1)
        const day = String(date.getDate()).padStart(2, '0'); // 일
        const hours = String(date.getHours()).padStart(2, '0'); // 시
        const minutes = String(date.getMinutes()).padStart(2, '0'); // 분

        const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
        const weekday = weekdays[date.getDay()]; // 요일

        return `${year}.${month}.${day}. (${weekday}) ${hours}:${minutes}`;
    }

    window.onload = function () {
        getUserInfo(accessToken).then(user => {
            userId = user.userId;
            email = user.email;
            nickname = user.nickname;
        });
        getTransactionList();
    };
</script>

</body>
</html>
